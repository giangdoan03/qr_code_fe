<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>N·ªôi dung QR Text</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

    <style>
        body { background: #111; color: #fff; padding: 2rem; font-family: sans-serif; }
    </style>
</head>
<body>

<h2 class="text-xl font-bold mb-4">üìÑ N·ªôi dung vƒÉn b·∫£n t·ª´ QR</h2>

<div id="output" class="space-y-4">ƒêang t·∫£i...</div>

<!-- ‚úÖ Handlebars template -->
<script id="text-template" type="text/x-handlebars-template">
    <div class="relative bg-[#222] p-4 pt-10 rounded-md">
        <pre class="whitespace-pre-wrap break-words text-sm" id="qr-text">{{data}}</pre>

        <button
                onclick="copyTextToClipboard('{{jsEscape data}}')"
                class="absolute top-2 right-2 bg-gray-700 text-white px-3 py-1 rounded hover:bg-green-600 transition text-sm flex items-center gap-2"
                title="Sao ch√©p"
        >
            <i class="fa fa-copy"></i> Copy
        </button>

        <div id="copy-status" class="text-green-400 text-xs mt-2 hidden">‚úÖ ƒê√£ sao ch√©p v√†o clipboard!</div>
    </div>
</script>

<script src="./js/api.js"></script>

<script>
    // Escape string to safely inject into onclick attribute
    Handlebars.registerHelper('jsEscape', function (text) {
        return (text || '').replace(/'/g, "\\'").replace(/\\n/g, '\\n');
    });

    function copyTextToClipboard(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                document.getElementById('copy-status').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('copy-status').classList.add('hidden');
                }, 2000);
            }).catch(() => {
                alert('Kh√¥ng th·ªÉ sao ch√©p.');
            });
        } else {
            // Fallback for old browsers
            const textarea = document.createElement("textarea");
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand("copy");
                document.getElementById('copy-status').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('copy-status').classList.add('hidden');
                }, 2000);
            } catch {
                alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ sao ch√©p.");
            }
            document.body.removeChild(textarea);
        }
    }

    async function loadTextQR() {
        const qrId = new URLSearchParams(window.location.search).keys().next().value || '';
        const output = document.getElementById("output");

        try {
            const json = await callApi(`/qr-codes/detail/${qrId}`);
            if (!json.qr || !json.target) {
                output.innerHTML = `<p class="text-red-400">Kh√¥ng t√¨m th·∫•y m√£ QR.</p>`;
                return;
            }

            const settings = JSON.parse(json.qr.settings_json || '{}');
            const text = settings.data || '(Kh√¥ng c√≥ n·ªôi dung)';

            const tplSource = document.getElementById('text-template').innerHTML;
            const template = Handlebars.compile(tplSource);
            output.innerHTML = template({ data: text });

        } catch (err) {
            output.innerHTML = `<p class="text-red-400">L·ªói k·∫øt n·ªëi ƒë·∫øn API</p>`;
        }
    }

    loadTextQR();
</script>

</body>
</html>
